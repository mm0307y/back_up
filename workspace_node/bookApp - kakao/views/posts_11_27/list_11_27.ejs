<style>
  .heart0,
  .heart1 {
    cursor: pointer;
    float: right;
    color: red;
    font-size: 1.5rem;
  }

  .fcnt {
    font-size: 0.5rem;
    float: right;
    margin-top: 15px;
  }
</style>
<div class="row my-2">
  <div class="col">
    <h1 class="text-center mb-2">ê²Œì‹œê¸€</h1>
    <div class="text-end">
      <button class="btn btn-primary btn-sm" id="btn-write">ê¸€ì“°ê¸°</button>
    </div>
    <div id="posts"></div>
    <div class="text-center my-3" id="btn-group" style="display:none">
      <button class="btn btn-primary btn-sm" id="btn-prev">ì´ì „</button>
      <span class="px-2" id="span-page">1</span>
      <button class="btn btn-primary btn-sm" id="btn-next">ë‹¤ìŒ</button>
    </div>
  </div>
</div>

<script type="text/x-handlebars-template" id="temp-posts">
  <!-- each ì˜†ì— deptsëŒ€ì‹ ì— ì¹´ì¹´ì˜¤ ë„ì„œ ê²€ìƒ‰ ê²°ê³¼ ë¼ë²¨ì€ documents ë°°ì—´ì˜ ì´ë¦„
  ë§Œì¼ ì´ë¦„ì´ ë‹¤ë¥´ë©´ ì¶œë ¥ì´ ì•ˆëœë‹¤. ì£¼ì˜
  í…œí”Œë¦¿ì—ì„œ JSONë°ì´í„° ì•ˆì˜ JSON ë°ì´í„°ëŠ” .ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.
  -->

{{#each this}}
<!-- ì•„ë˜ êµ¬ê°„ì´ në²ˆ ë°˜ë³µí•´ì•¼ í•œë‹¤. ì›ë˜ë©´ forë¬¸ ë˜ëŠ” whileë¬¸ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤. -->
<div class="card my-2">
  <div class="card-body">
    <a href="/posts/{{ id }}">{{ title }}</a>
    <div class="ellipsis">{{body}}</div>
  </div>
  <div class="card-footer">
    <span>Posted on {{ date }} by {{ email }}</span>
    <span class="heart{{ucnt}}" id="{{id}}">
      <span>
        <span>{{heart ucnt}}</span>
        <span class="fcnt">{{fcnt}}</span>
      </span>
    </span>
  </div>
  {{/each}}
</script>

<script>
  // fcnt - ì „ì²´ ì¢‹ì•„ìš” ê°¯ìˆ˜, ucnt - ìœ ì €(ë„ˆ)ê°€ ì¢‹ì•„ìš” ê°¯ìˆ˜
  // ì±„ì›Œì§„ í•˜íŠ¸ëŠ” ë‚´ê°€ ëˆ„ë¥¸ ì¢‹ì•„ìš”. ì´ê³  ë¹ˆ í•˜íŠ¸ëŠ” ì „ì²´ ì¢‹ì•„ìš” ìˆ˜ì…ë‹ˆë‹¤.
  Handlebars.registerHelper("heart", (ucnt) => {
    if (ucnt == 0) return 'ğŸ¤'; else return 'â¤';
  })
</script>

<script type="module">
  import { app } from "/javascripts/firebase_11_25.js"
  import { getFirestore, getDocs, collection, query, orderBy, where, addDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
  const db = getFirestore(app)
  // ë¸Œë¼ìš°ì € ë¡œì»¬ì €ì¥ì†Œì— ìˆëŠ” ê°’ì„ ì½ì–´ì˜¤ê¸°
  const email = localStorage.getItem("email")

  getList()
  async function getList() {
    const q = query(collection(db, "posts"), orderBy('date', "desc"))
    const snapshot = await getDocs(q)

    // ì¢‹ì•„ìš”ì— ëŒ€í•œ ì •ë³´ë¥¼ ì¶”ê°€í•˜ì—¬ ë‹´ì„ ë°°ì—´ ì„ ì–¸
    let rows = []
    console.log(snapshot.empty)

    // firestoreì—ì„œ ê°€ì ¸ì˜¨ collectionì´ ì—†ë‹¤ë©´ ì•„ë˜ ì½”ë“œë¥¼ ì§„í–‰í•  í•„ìš”ê°€ ì—†ì–´ì„œ 
    // returnì„ ì‚¬ìš©í•œë‹¤.
    if (snapshot.empty) {
      console.log("ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
      return // í•¨ìˆ˜ë¥¼ ë¹ ì ¸ ë‚˜ê°„ë‹¤. ì™œëƒí•˜ë©´ ë°”ì¸ë”©í•  ë°ì´í„°ì…‹ì´ ì—†ìœ¼ë¯€ë¡œ
    }

    // ê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜¤ê¸°
    // const posts = snapshot.docs.map(doc => doc.data())
    snapshot.docs.forEach(async (row, index) => {
      console.log(row)
      console.log(index)

      // ì „ì²´ ì¢‹ì•„ìš” ê°¯ìˆ˜
      const q1 = query(collection(db, "favorite"), where("pid", "==", row.id))
      const snap1 = await getDocs(q1)
      console.log(snap1.docs.length)

      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì¢‹ì•„ìš” ì²´í¬
      const q2 = query(collection(db, "favorite"), where("pid", "==", row.id), where("email", "==", email))
      const snap2 = await getDocs(q2)
      // console.log(snap2.docs.length)

      // postsì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ì— ì „ì²´ì¢‹ì•„ìš”ì™€ ì‚¬ìš©ì ì¢‹ì•„ìš” ê°¯ìˆ˜ë¥¼ í¬í•¨ ì‹œí‚¨ë‹¤.
      // ë°°ì—´ì— ê°’ì„ ì¶”ê°€í•  ë•ŒëŠ” pushì„ ì‚¬ìš©í•œë‹¤.
      rows.push({ id: row.id, ...row.data(), fcnt: snap1.docs.length, ucnt: snap2.docs.length })
      // console.log(rows)

      let temp = Handlebars.compile($("#temp-posts").html())
      $("#posts").html(temp(rows))
    })
  } // end of getList

  // ì¢‹ì•„ìš” ì¶”ê°€
  $("#posts").on("click", ".heart0", async function () {
    let id = $(this).attr("id")
    // console.log(`pid: ${id}`)
    // emailì´ ìˆë‹¤ëŠ” ê±´ ë¡œê·¸ì¸ ìƒíƒœì´ë‹¤. - localStorage.getItem("email")
    if (email) {
      await addDoc(collection(db, "favorite"), { pid: id, email: email })
      console.log("ì¢‹ì•„ìš” ì¶”ê°€")
      getList()
    }
    // ì´ë©”ì¼ì´ ì—†ëŠ” ê²½ìš° ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•œë‹¤.
    else (
      loaction.href = "/login"
    )
  })

  // ì¢‹ì•„ìš” ì·¨ì†Œ

  $("#btn-write").on("click", () => {
    // emailì´ ìˆìœ¼ë©´ ê¸€ì“°ê¸°ë¡œ ì´ë™í•´ì¤˜
    location.href = "/posts/write"
  })
</script>